LOWL_LIB_SHORTNAME = lowl
LOWL_LIB_NAME = lib$(LOWL_LIB_SHORTNAME)$(SHLIB_SUFFIX)
LOWL_LIB_FILENAME = $(LOWL_LIB_NAME)
LOWL_LIB = $(LOWL_BLD_DIR)/$(LOWL_LIB_FILENAME)

LOWL_TESTS_SOURCE = $(LOWL_SRC_DIR)/tests.c
LOWL_TESTS = $(LOWL_BLD_DIR)/tests

LOWL_SOURCES = $(filter-out $(LOWL_TESTS_SOURCE),$(wildcard $(LOWL_SRC_DIR)/*.c))
LOWL_OBJECTS = $(patsubst $(LOWL_SRC_DIR)/%.c,$(LOWL_BLD_DIR)/%.o,$(LOWL_SOURCES))

$(LOWL_BLD_DIR)/%.o: $(LOWL_SRC_DIR)/%.c $(LOWL_SRC_DIR)/%.h
	@mkdir -p $(LOWL_BLD_DIR)
	$(CC) -std=gnu99 -fPIC -o $@ -c $<

$(LOWL_LIB): $(LOWL_OBJECTS)
	@mkdir -p $(LOWL_BLD_DIR)
	$(CC) -std=gnu99 -shared -Wl,$(SHLIB_NAME_FLAG),$(LOWL_LIB_NAME) -o $(LOWL_LIB) $(LOWL_OBJECTS) -lm

$(LOWL_TESTS): $(LOWL_TESTS_SOURCE) $(LOWL_LIB)
	@mkdir -p $(LOWL_BLD_DIR)
	$(CC) -std=gnu99 -o $@ $< -L$(LOWL_BLD_DIR) -l$(LOWL_LIB_SHORTNAME) -lm

.PHONY: lowl
lowl: $(LOWL_LIB)

.PHONY: lowl-tests
lowl-tests: export LD_LIBRARY_PATH=$(LOWL_BLD_DIR)
lowl-tests: $(LOWL_TESTS)
	./$(LOWL_TESTS)
