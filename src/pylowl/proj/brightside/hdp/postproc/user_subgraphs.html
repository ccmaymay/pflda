<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<style>

body {
    font: sans-serif;
}

.node {
}

.graph_container {
    float: left;
    padding: 10px;
    margin-right: 20px;
    margin-bottom: 10px;
}

#inputWindowParameters {
    border: 1px solid black;
	position: fixed;
	right: 0;
	top: 0;
    background-color: rgba(255,255,255,.85);
    padding: 10px;
}
</style>

</head>
<body>

<div id="inputWindowParameters">
    <div><a href="graph.html">graph</a></div>
    <div><a href="subgraphs.html">subgraphs</a></div>
    <div>
        <label for="user_select">user:</label>
        <select id="user_select" onChange="update_num_graphs(); $update_window_size(); update_graphs();"></select>
	</div>
    <div>
        navigate:
        <input type="button" onclick="$shift_window(-1); update_graphs();"
        value="<" />
        <input type="button" onclick="$shift_window(1); update_graphs();"
        value=">" />
        window size: <input id="window_size" maxlength="3"
        size="3" type="text" onchange="$update_window_size(); update_graphs();" />
    </div>
    <div id="status">
        showing subgraphs <span id="window_start_text"></span> to
        <span id="window_end_text"></span> of <span
            id="num_graphs_text"></span>
    </div>
</div>

<div id="graphs_container"> </div>

<script src="d3.v3.js"></script>

<script src="core.js"></script>

<script>
$window_size = 5;
$window_start = 0;
$num_windows = 0;
$num_graphs = 0;


var graph_length = function(node) {
    var nested_node = node;
    for (var n = 0; nested_node.children.length > 0; ++n) {
        nested_node = nested_node.children[0];
    }
    return n;
}

var lookup_node = function(node, n) {
    var nested_node = node;
    for (var j = 0; j < n; ++j) {
        nested_node = nested_node.children[0];
    }
    return nested_node
}

var format_words = function(n) {
    var graph_node = lookup_node($graph_root, n);
    var s = "";
    for (var w in graph_node.words) {
        if (w > 0) {
            s += " ";
        }
        s += graph_node.words[w]['word'];
    }
    return s;
}

update_num_graphs = function() {
    var user_select = document.getElementById("user_select");
    var selected_user = user_select.value;
    $num_graphs = 0;
    for (var m = 0; m < $total_num_graphs; ++m) {
        var user = $root[m]["user"];
        if (selected_user == user) {
            ++$num_graphs;
        }
    }
}

var update_graphs = function() {
    var user_select = document.getElementById("user_select");
    var selected_user = user_select.value;
    var user_doc_indices = [];
    for (var m = 0; m < $total_num_graphs; ++m) {
        var user = $root[m]["user"];
        if (selected_user == user) {
            user_doc_indices.push(m);
        }
    }
    $num_graphs = user_doc_indices.length;

    $shift_window(0);
    $update_nav_text();

    var graphs_container = document.getElementById("graphs_container");
    while (graphs_container.hasChildNodes()) {
        graphs_container.removeChild(graphs_container.firstChild);
    }

    var purple_ramp = d3.scale.linear().domain([0,1]).range(["#fff","#c0c"]);
    var red_ramp = d3.scale.linear().domain([0,1]).range(["#fff","#c03"]);
    var blue_ramp = d3.scale.linear().domain([0,1]).range(["#fff","#30c"]);

    var node_size = 10;
    var K = graph_length($graph_root) + 1;
    var L = graph_length($root[0]["sublist"]) + 1;

    var svg_width = (L + 4) * node_size;
    var svg_height = (K + 2) * node_size;

    var summary_svg_width = $num_graphs * node_size;
    var summary_svg_height = K * node_size;

    var graph_container = document.createElement("div");
    graph_container.className = "graph_container";
    graphs_container.appendChild(graph_container);

    var summary_container = document.createElement("div");
    graph_container.appendChild(summary_container);
    var summary_text = document.createTextNode("topic summary over time");
    summary_container.appendChild(summary_text);

    var inner_graph_container = document.createElement("div");
    graph_container.appendChild(inner_graph_container);

    var svg = d3.select(inner_graph_container).append("svg")
            .attr("width", summary_svg_width)
            .attr("height", summary_svg_height)
        .append("g")
            .attr("transform", "translate(0,0)");

    var summary_rect = svg.selectAll(".summary_node")
            .data(d3.range(0, K*$num_graphs))
        .enter().append("rect")
            .attr("class", "summary_node")
            .attr("width", node_size)
            .attr("height", node_size)
            .attr("x", function(x) { return (x % $num_graphs) * node_size; })
            .attr("y", function(x) { return Math.floor(x / $num_graphs) * node_size; });

    summary_rect.style("stroke", "#cac")
        .style("fill", function(x) {
            return blue_ramp($root[user_doc_indices[x % $num_graphs]]["Ephi"][Math.floor(x / $num_graphs)]);
        });

    var user_m = 0;
    for (var m = 0; m < $total_num_graphs; ++m) {
        var doc_id = $root[m]["doc_id"];
        var user = $root[m]["user"];
        var date_str = $root[m]["date_str"];

        if (selected_user == user) {
            if (user_m >= $window_start && user_m < $window_end) {
                var graph_container = document.createElement("div");
                graph_container.className = "graph_container";
                graphs_container.appendChild(graph_container);

                var doc_id_container = document.createElement("div");
                graph_container.appendChild(doc_id_container);
                var doc_id_text = document.createTextNode(doc_id);
                doc_id_container.appendChild(doc_id_text);

                var date_container = document.createElement("div");
                graph_container.appendChild(date_container);
                var date_text = document.createTextNode(date_str);
                date_container.appendChild(date_text);

                var inner_graph_container = document.createElement("div");
                graph_container.appendChild(inner_graph_container);

                var svg = d3.select(inner_graph_container).append("svg")
                        .attr("width", svg_width)
                        .attr("height", svg_height)
                    .append("g")
                        .attr("transform", "translate(0,0)");

                var global_left_header_rect = svg.selectAll(".global_left_header_node")
                        .data(d3.range(0, K))
                    .enter().append("rect")
                        .attr("class", "global_left_header_node")
                        .attr("width", node_size)
                        .attr("height", node_size)
                        .attr("y", function(k) { return (k + 2) * node_size; });

                global_left_header_rect.style("stroke", "#cac")
                    .style("fill", function(k) {
                        var node = lookup_node($graph_root, k);
                        return red_ramp(Math.exp(node.Elogpi));
                    });

                var left_header_rect = svg.selectAll(".left_header_node")
                        .data(d3.range(0, K))
                    .enter().append("rect")
                        .attr("class", "left_header_node")
                        .attr("width", node_size)
                        .attr("height", node_size)
                        .attr("x", function(k) { return 2 * node_size; })
                        .attr("y", function(k) { return (k + 2) * node_size; });

                left_header_rect.style("stroke", "#cac")
                    .style("fill", function(k) {
                        return blue_ramp($root[m]["Ephi"][k]);
                    });

                var top_header_rect = svg.selectAll(".top_header_node")
                        .data(d3.range(0, L))
                    .enter().append("rect")
                        .attr("class", "top_header_node")
                        .attr("width", node_size)
                        .attr("height", node_size)
                        .attr("x", function(j) { return (j + 4) * node_size; });

                top_header_rect.style("stroke", "#cac")
                    .style("fill", function(j) {
                        var node = lookup_node($root[m]["sublist"], j);
                        return blue_ramp(Math.exp(node.Elogpi));
                    });

                var rect = svg.selectAll(".node")
                        .data(d3.range(0, L*K))
                    .enter().append("rect")
                        .attr("class", "node")
                        .attr("width", node_size)
                        .attr("height", node_size)
                        .attr("x", function(d) { return (4 + (d % L)) * node_size; })
                        .attr("y", function(d) { return (2 + Math.floor(d / L)) * node_size; });

                rect.style("stroke", "#cac")
                    .style("fill", function(d) {
                        var j = (d % L);
                        var k = Math.floor(d / L);
                        var node = lookup_node($root[m]["sublist"], j);
                        return purple_ramp(node.phi[k]);
                    })
                    .append("title")
                    .text(function(d) {
                        var j = (d % L);
                        var k = Math.floor(d / L);
                        return k + ": " + format_words(k);
                    });
            }

            ++user_m;
        }
    }
}

d3.json("graph.json", function(error, graph_root) {
    $graph_root = graph_root;
    d3.json("user_subgraphs.json", function(error, root) {
        $root = root;
        $total_num_graphs = root.length;

        var user_select = document.getElementById("user_select");

        var users = {};

        for (var m = 0; m < $total_num_graphs; ++m) {
            var user = $root[m]["user"];

            if (! (user in users)) {
                users[user] = true;

                var user_option = document.createElement("option");
                user_select.appendChild(user_option);
                user_option.setAttribute("value", user);
                var user_option_text = document.createTextNode(user);
                user_option.appendChild(user_option_text);
            }
        }

        update_num_graphs();
        document.getElementById("window_size").value = $window_size;
        $update_window_size();
        update_graphs();
    });
});

</script>

</body>
</html>
