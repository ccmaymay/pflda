<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<style>

body {
    font: sans-serif;
}

.graph_container {
    float: left;
    padding: 10px;
}

.node circle {
    stroke: #000;
    stroke-width: 1.5px;
    fill: #000;
}

.node {
    font: 10px sans-serif;
}

.link {
    fill: none;
    stroke: #000;
    stroke-width: 1.5px;
}

#inputWindowParameters {
    border: 1px solid black;
	position: fixed;
	right: 0;
	top: 0;
    background-color: rgba(255,255,255,.85);
    padding: 10px;
}

#lambda_text{
    border: 1px solid black;
	background-color: rgba(255,255,255,.85);
    display: inline-block;
    padding: 2px;
}
</style>

</head>
<body>

<div id="inputWindowParameters">
    <div><a href="graph.html">graph</a></div>
    <div>
        navigate:
        <input type="button" onclick="$shift_window(-1); update_graphs();"
        value="<" />
        <input type="button" onclick="$shift_window(1); update_graphs();"
        value=">" />
        window size: <input id="window_size" maxlength="3"
        size="3" type="text" onchange="$update_window_size(); update_graphs();" />
    </div>
    <div id="status">
        showing subgraphs <span id="window_start_text"></span> to
        <span id="window_end_text"></span> of <span
            id="num_graphs_text"></span>
    </div>
    <div id="showCounts">
        <label for="showValues">show counts: </label><input type="checkbox"
        onchange="update_graphs();" id="showValues"/>
    </div>
</div>

<div id="graphs_container"></div>

<script src="d3.v3.js"></script>

<script src="core.js"></script>

<script>
$window_size = 5;
$window_start = 0;
$num_windows = 0;
$num_graphs = 0;
$node_sort_array = [];

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; })
    .source(function (d) {
        var s = Object.create(d.source);
        s.y += node_size(s);
        return s;
    })
    .target(function (d) {
        var t = Object.create(d.target);
        t.y -= node_size(t);
        return t;
    });

update_graphs = function() {
    $update_nav_text();

    var graphs_container = document.getElementById("graphs_container");
    while (graphs_container.hasChildNodes()) {
        graphs_container.removeChild(graphs_container.firstChild);
    }

    for (var c = $window_start; c < $window_end; ++c) {
        var maxEtime = maximum_param_subtreeChildren(null, $root[c]["subtree"], "expected_time");
        var minEtime = minimum_param_subtreeChildren(null, $root[c]["subtree"], "expected_time");
        var ramp = d3.scale.linear().domain([minEtime, maxEtime]).range(["blue","red"]);

        var cluster = d3.layout.cluster()
        .size([$height , $width - 14*$maxNodeSize]);

        var graph_container = document.createElement("div");
        graph_container.className = "graph_container";
        graphs_container.appendChild(graph_container);

        var user = $root[c]["user"];
        var user_container = document.createElement("div");
        graph_container.appendChild(user_container);
        var user_text = document.createTextNode(user);
        user_container.appendChild(user_text);

        var inner_graph_container = document.createElement("div");
        graph_container.appendChild(inner_graph_container);

        var svg = d3.select(inner_graph_container).append("svg")
        .attr("width", $width)
        .attr("height", $height)
        .append("g")
        .attr("transform", "translate("+ 2.5*($maxNodeSize+1) +",0)");

        var nodes = cluster.nodes($root[c]["subtree"]);
        var links = cluster.links(nodes);

        var link = svg.selectAll(".link")
        .data(links)
        .enter().append("path")
        .attr("class", "link")
        .attr("d", diagonal)
        .style("stroke-opacity", function(d) { return d.target.active ?
               "1" : "0.1"; });

        var node = svg.selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" +
              d.y + "," + d.x + ")"; });

        node.append("circle")
		.attr("r", function(d){return node_size(d);})
        .style("fill", function(d) {return d.active ?
               ramp(d.expected_time) : "black"})
        .style("stroke", function(d) {return d.active ?
               ramp(d.expected_time) : "black"})
        .style("stroke-opacity", function(d) { return d.active ?
               (0.1 + 0.9*(d.Elogpi-$minELogPi)/($maxELogPi-$minELogPi)) : "0.1"; })
        .style("fill-opacity", function(d) { return d.active ?
               (0.1 + 0.9*(d.Elogpi-$minELogPi)/($maxELogPi-$minELogPi)) : "0.1"; });

        node.append("circle")
        .attr("r", $maxNodeSize + 1)
        .style("fill", "black")
        .style("stroke", "black")
        .style("stroke-opacity", function(d){return d.active ? (d.circled? "1":"0"): (d.circled? ".15":"0")})
        .style("fill-opacity", "0")
		.on("click", function(d){$filter_node_first(d); update_graphs();})
        .append("title")
        .text(format_words);

        if(document.getElementById("showValues").checked == true){
			node.append("foreignObject")
				.attr("width", 200)
				.attr("height", 30)
				.append("xhtml:body")
				.html(add_lambda_ss_text(10));
        }
    }
}

d3.json("graph.json", function(error, graph_root) {
    $graph_root = graph_root;
    d3.json("subgraphs.json", function(error, root) {
        $num_graphs = root.length;
        $root = root;
        node_placement_rootParent();
        $maxNodeSize = maximum_Node_Size_rootParent($root);
        $minELogPi = minimum_param_rootParent($root, "Elogpi");
        $maxELogPi = maximum_param_rootParent($root, "Elogpi");
        
		$width = $maxNodeSize * 16 * (tree_depth(root[0]["subtree"]) + 1) + $maxNodeSize;
        var sizes = tree_size_per_level(root[0]["subtree"]);
        var eff_size = sizes[sizes.length - 1] + (sizes.length > 1 ? sizes[sizes.length - 2] : 0);
        $height = $maxNodeSize * 2.5 * eff_size + $maxNodeSize;

        document.getElementById("window_size").value = $window_size;
        $update_window_size();
        update_graphs();

        d3.select(self.frameElement).style("height", $height + "px");
    });
});

</script>

</body>
</html>
